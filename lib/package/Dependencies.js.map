{"version":3,"sources":["../../src/package/Dependencies.js"],"names":["fs","require","path","mkdirp","execSync","copyFile","AbstractService","Dependencies","commands","npm","yarn","nodeJsDir","join","process","cwd","plugin","settings","compileDir","cmd","console","log","env","toString","filename","destination","init","filePath","isAbsolute","resolve","existsSync","Promise","copyErr","sync","copyProjectFile","packagePath","packageManager","packageLockPath","yarnLockPath","customInstallationCommand","run","module","exports"],"mappings":"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","sourcesContent":["const fs = require('fs');\nconst path = require('path');\nconst mkdirp = require('mkdirp');\nconst { execSync } = require('child_process');\nconst copyFile = require('fs-copy-file'); // node v6.10.3 support\n\nconst AbstractService = require('../AbstractService');\n\nclass Dependencies extends AbstractService {\n  init() {\n    this.commands = {\n      npm: 'npm install --production',\n      yarn: 'yarn --production'\n    };\n    this.nodeJsDir = path.join(process.cwd(), this.plugin.settings.compileDir, 'layers', 'nodejs');\n  }\n\n  run(cmd) {\n    console.log(execSync(cmd, {\n      cwd: this.nodeJsDir,\n      env: process.env\n    }).toString());\n  }\n\n  copyProjectFile(filename, destination) {\n    this.init();\n    let filePath;\n    if (path.isAbsolute(filename)) {\n      filePath = filename;\n    } else {\n      filePath = process.resolve(path.cwd(), filename);\n    }\n\n    if (!fs.existsSync(filePath)) {\n      this.plugin.log(`[warning] \"${filename}\" file does not exists!`);\n      return true;\n    }\n\n    return new Promise((resolve) => {\n      copyFile(filePath, path.join(this.nodeJsDir, destination), (copyErr) => {\n        if (copyErr) throw copyErr;\n        return resolve();\n      });\n    });\n  }\n\n  async install() {\n    this.init();\n    this.plugin.log('Dependencies has changed! Re-installing...');\n\n    await mkdirp.sync(this.nodeJsDir);\n    await this.copyProjectFile(this.plugin.settings.packagePath, 'package.json');\n\n    if (this.plugin.settings.packageManager === 'npm') {\n      await this.copyProjectFile(this.plugin.settings.packageLockPath || 'package-lock.json', 'package-lock.json');\n    }\n\n    if (this.plugin.settings.packageManager === 'yarn') {\n      await this.copyProjectFile(this.plugin.settings.yarnLockPath || 'yarn.lock', 'yarn.lock');\n    }\n\n    // custom commands\n    if (this.plugin.settings.customInstallationCommand) {\n      return this.run(this.plugin.settings.customInstallationCommand);\n    }\n\n    // packages installation\n    return this.run(this.commands[this.plugin.settings.packageManager]);\n  }\n}\n\nmodule.exports = Dependencies;\n"],"file":"Dependencies.js"}